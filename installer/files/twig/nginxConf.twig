{% if config.TLS_ENABLE %}
server {
    listen 443 ssl http2;
    server_name {{config.DOMAIN}}

    ssl on;
	
	ssl_certificate      {{config.TLS_CERT_PATH}};
	ssl_certificate_key  {{config.TLS_KEY_PATH}};
	
	ssl_session_cache    shared:SSL:1m;
	ssl_session_timeout  5m;

	ssl_protocols TLSv1.2;
	
	ssl_dhparam {{config.DHPARAM_PATH}};
	
	ssl_ciphers 'ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4';
	ssl_prefer_server_ciphers  on;
	
	index index.php;

	root {{root}}/public;
	
	client_max_body_size 10m;
	
	{% if config.HSTS_ENABLE %}
	add_header Strict-Transport-Security "max-age=31536000; includeSubdomains;";
	{% endif %}

	location / {
		try_files $uri $uri/ /index.php$is_args$args;
	}

	location ~ \.php {
		try_files $uri =404;
		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		include fastcgi_params;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		fastcgi_param SCRIPT_NAME $fastcgi_script_name;
		fastcgi_index index.php;
		fastcgi_pass 127.0.0.1:9000;
	}

	# deny access to .htaccess files, if Apache's document root
	# concurs with nginx's one
	
	location ~ /\.ht {
		deny  all;
	}
}

server {
	listen       80;
	server_name  {{config.DOMAIN}};

	return 301 https://$host$request_uri;
}
{% else %}
server {
	listen       80;
	server_name  {{config.DOMAIN}};

	root {{root}}/public;
	
	client_max_body_size 10m;
	
	index index.php;

	location / {
		try_files $uri $uri/ /index.php$is_args$args;
	}

	location ~ \.php {
		try_files $uri =404;
		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		include fastcgi_params;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		fastcgi_param SCRIPT_NAME $fastcgi_script_name;
		fastcgi_index index.php;
		fastcgi_pass 127.0.0.1:9000;
	}

	# deny access to .htaccess files, if Apache's document root
	# concurs with nginx's one
	
	location ~ /\.ht {
		deny  all;
	}
}
{% endif %}
